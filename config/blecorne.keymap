// Miryoku ZMK keymap for BLE Corne (3x6+3 = 42 keys)
// Options: QWERTY alphas, INVERTEDT nav, MAC clipboard
// Extra pinky columns: GRAVE/EQUAL/LBKT (left), SQT/MINUS/RBKT (right)
//
// Based on: https://github.com/manna-harbour/miryoku_zmk
//
// Layer indices:
//   0 = BASE    4 = NAV     7 = NUM
//   1 = EXTRA   5 = MOUSE   8 = SYM
//   2 = TAP     6 = MEDIA   9 = FUN
//   3 = BUTTON

#include <behaviors.dtsi>
#include <behaviors/mouse_keys.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/rgb.h>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/zmk/ext_power.h>
#include <dt-bindings/zmk/pointing.h>

// --- Layer indices ---
#define U_BASE   0
#define U_EXTRA  1
#define U_TAP    2
#define U_BUTTON 3
#define U_NAV    4
#define U_MOUSE  5
#define U_MEDIA  6
#define U_NUM    7
#define U_SYM    8
#define U_FUN    9

// --- Timing ---
#define U_TAPPING_TERM 200

// --- Mouse settings ---
#define ZMK_POINTING_DEFAULT_MOVE_VAL 1250
#define ZMK_POINTING_DEFAULT_SCRL_VAL 100

// --- Mac clipboard ---
#define U_RDO &kp LS(LG(Z))
#define U_PST &kp LG(V)
#define U_CPY &kp LG(C)
#define U_CUT &kp LG(X)
#define U_UND &kp LG(Z)

// --- Helpers ---
#define U_NP &none
#define U_NA &none
#define U_NU &none

// --- Mouse bindings ---
#define U_BTN1 &mkp MB1
#define U_BTN2 &mkp MB2
#define U_BTN3 &mkp MB3
#define U_MS_D &mmv MOVE_DOWN
#define U_MS_L &mmv MOVE_LEFT
#define U_MS_R &mmv MOVE_RIGHT
#define U_MS_U &mmv MOVE_UP
#define U_WH_D &msc SCRL_DOWN
#define U_WH_L &msc SCRL_LEFT
#define U_WH_R &msc SCRL_RIGHT
#define U_WH_U &msc SCRL_UP

// --- RGB / EP ---
#define U_RGB_TOG &rgb_ug RGB_TOG
#define U_RGB_EFF &rgb_ug RGB_EFF
#define U_RGB_HUI &rgb_ug RGB_HUI
#define U_RGB_SAI &rgb_ug RGB_SAI
#define U_RGB_BRI &rgb_ug RGB_BRI
#define U_EP_TOG  &ext_power EP_TOG

// ============================================================
// Shift-function mod-morph macro: tap = BINDING, shift+tap = SHIFT_BINDING
// ============================================================

#define MIRYOKU_SHIFT_FUNCTION(NAME, BINDING, SHIFT_BINDING) \
/ { \
  behaviors { \
    NAME: NAME { \
      compatible = "zmk,behavior-mod-morph"; \
      #binding-cells = <0>; \
      bindings = <BINDING>, <SHIFT_BINDING>; \
      mods = <(MOD_LSFT|MOD_RSFT)>; \
    }; \
  }; \
};

#define U_MACRO(name,...) \
/ { \
  macros { \
    name: name { \
      compatible = "zmk,behavior-macro"; \
      #binding-cells = <0>; \
      __VA_ARGS__ \
    }; \
  }; \
};

#define MIRYOKU_SHIFT_MACRO(NAME, BINDING, SHIFT_BINDING) \
U_MACRO(u_macro_ ## NAME, wait-ms = <0>; bindings = <SHIFT_BINDING>;) \
MIRYOKU_SHIFT_FUNCTION(NAME, BINDING, &u_macro_ ## NAME)

// --- BT select (tap = select, shift+tap = select & clear) ---
MIRYOKU_SHIFT_MACRO(u_bt_sel_0, &bt BT_SEL 0, &bt BT_SEL 0 &bt BT_CLR)
MIRYOKU_SHIFT_MACRO(u_bt_sel_1, &bt BT_SEL 1, &bt BT_SEL 1 &bt BT_CLR)
MIRYOKU_SHIFT_MACRO(u_bt_sel_2, &bt BT_SEL 2, &bt BT_SEL 2 &bt BT_CLR)
MIRYOKU_SHIFT_MACRO(u_bt_sel_3, &bt BT_SEL 3, &bt BT_SEL 3 &bt BT_CLR)

// --- Output toggle (tap = toggle, shift+tap = force USB) ---
MIRYOKU_SHIFT_FUNCTION(u_out_tog, &out OUT_TOG, &out OUT_USB)

// --- Caps word (tap = caps_word, shift+tap = caps lock) ---
MIRYOKU_SHIFT_FUNCTION(u_caps_word, &caps_word, &kp CAPS)

// ============================================================
// Double-tap guard: requires double-tap to activate (prevents accidental triggers)
// ============================================================

#define MIRYOKU_DOUBLE_TAP_GUARD(NAME, BINDING) \
/ { \
  behaviors { \
    NAME: NAME { \
      compatible = "zmk,behavior-tap-dance"; \
      #binding-cells = <0>; \
      tapping-term-ms = <U_TAPPING_TERM>; \
      bindings = <&none>, <BINDING>; \
    }; \
  }; \
};

MIRYOKU_DOUBLE_TAP_GUARD(u_to_U_BASE,   &to U_BASE)
MIRYOKU_DOUBLE_TAP_GUARD(u_to_U_EXTRA,  &to U_EXTRA)
MIRYOKU_DOUBLE_TAP_GUARD(u_to_U_TAP,    &to U_TAP)
MIRYOKU_DOUBLE_TAP_GUARD(u_to_U_BUTTON, &to U_BUTTON)
MIRYOKU_DOUBLE_TAP_GUARD(u_to_U_NAV,    &to U_NAV)
MIRYOKU_DOUBLE_TAP_GUARD(u_to_U_MOUSE,  &to U_MOUSE)
MIRYOKU_DOUBLE_TAP_GUARD(u_to_U_MEDIA,  &to U_MEDIA)
MIRYOKU_DOUBLE_TAP_GUARD(u_to_U_NUM,    &to U_NUM)
MIRYOKU_DOUBLE_TAP_GUARD(u_to_U_SYM,    &to U_SYM)
MIRYOKU_DOUBLE_TAP_GUARD(u_to_U_FUN,    &to U_FUN)

// ============================================================
// Hold-tap behaviors (home row mods and layer taps)
// ============================================================

/ {
  behaviors {
    u_mt: u_mt {
      compatible = "zmk,behavior-hold-tap";
      #binding-cells = <2>;
      tapping-term-ms = <U_TAPPING_TERM>;
      flavor = "tap-preferred";
      bindings = <&kp>, <&kp>;
    };
    u_lt: u_lt {
      compatible = "zmk,behavior-hold-tap";
      #binding-cells = <2>;
      tapping-term-ms = <U_TAPPING_TERM>;
      flavor = "tap-preferred";
      bindings = <&mo>, <&kp>;
    };
  };
};

// ============================================================
// Mouse movement tuning
// ============================================================

&mmv {
  acceleration-exponent = <1>;
  time-to-max-speed-ms = <1500>;
  delay-ms = <0>;
};

// ============================================================
// Keymap
// ============================================================
//
// Physical layout (Corne 3x6+3):
//
// | C0  | C1  | C2  | C3  | C4  | C5  |     | C6  | C7  | C8  | C9  | C10 | C11 |
// | C12 | C13 | C14 | C15 | C16 | C17 |     | C18 | C19 | C20 | C21 | C22 | C23 |
// | C24 | C25 | C26 | C27 | C28 | C29 |     | C30 | C31 | C32 | C33 | C34 | C35 |
//                   | C36 | C37 | C38 |     | C39 | C40 | C41 |
//
// Miryoku 5x3+3 core maps into columns C1-C5 / C6-C10 (alphas)
// with C0/C11/C12/C23/C24/C35 as the extra pinky columns.
// Thumb cluster: C36-C38 (left), C39-C41 (right).
//
// Standard Miryoku thumb assignments (non-flip):
//   Left:  ESC/MEDIA  SPACE/NAV  TAB/MOUSE
//   Right: RET/SYM    BSPC/NUM   DEL/FUN

/ {
  keymap {
    compatible = "zmk,keymap";

    // ===== Layer 0: BASE (QWERTY) =====
    //
    // ,------------------------------------------.  ,------------------------------------------.
    // | GRAVE|  Q   |  W   |  E   |  R   |  T   |  |  Y   |  U   |  I   |  O   |  P   | SQT  |
    // | EQUAL| A/GUI| S/ALT| D/CTL| F/SFT|  G   |  |  H   | J/SFT| K/CTL| L/ALT|'/GUI | MINUS|
    // | LBKT | Z/BTN| X/ALT|  C   |  V   |  B   |  |  N   |  M   |  ,   | ./ALT|//BTN | RBKT |
    // `-------------| ESC  | SPACE| TAB  |-------.  .------| RET  | BSPC | DEL  |-------------'
    //               |MEDIA | NAV  | MOUSE|              SYM|  NUM |  FUN |
    //               `---------------------'              `---------------------'

    BASE {
      display-name = "Base";
      bindings = <
&kp GRAVE          &kp Q              &kp W              &kp E              &kp R              &kp T                &kp Y              &kp U              &kp I              &kp O              &kp P              &kp SQT
&kp EQUAL          &u_mt LGUI A       &u_mt LALT S       &u_mt LCTRL D      &u_mt LSHFT F      &kp G                &kp H              &u_mt LSHFT J      &u_mt LCTRL K      &u_mt LALT L       &u_mt LGUI SEMI    &kp MINUS
&kp LBKT           &u_lt U_BUTTON Z   &u_mt RALT X       &kp C              &kp V              &kp B                &kp N              &kp M              &kp COMMA          &u_mt RALT DOT     &u_lt U_BUTTON SLASH &kp RBKT
                                       &u_lt U_MEDIA ESC  &u_lt U_NAV SPACE  &u_lt U_MOUSE TAB  &u_lt U_SYM RET    &u_lt U_NUM BSPC   &u_lt U_FUN LG(SPACE)
      >;
    };

    // ===== Layer 1: EXTRA (QWERTY duplicate - default extra is QWERTY) =====

    EXTRA {
      display-name = "Extra";
      bindings = <
&none              &kp Q              &kp W              &kp E              &kp R              &kp T                &kp Y              &kp U              &kp I              &kp O              &kp P              &none
&none              &u_mt LGUI A       &u_mt LALT S       &u_mt LCTRL D      &u_mt LSHFT F      &kp G                &kp H              &u_mt LSHFT J      &u_mt LCTRL K      &u_mt LALT L       &u_mt LGUI SEMI    &none
&none              &u_lt U_BUTTON Z   &u_mt RALT X       &kp C              &kp V              &kp B                &kp N              &kp M              &kp COMMA          &u_mt RALT DOT     &u_lt U_BUTTON SLASH &none
                                       &u_lt U_MEDIA ESC  &u_lt U_NAV SPACE  &u_lt U_MOUSE TAB  &u_lt U_SYM RET    &u_lt U_NUM BSPC   &u_lt U_FUN LG(SPACE)
      >;
    };

    // ===== Layer 2: TAP (QWERTY without home row mods) =====

    TAP {
      display-name = "Tap";
      bindings = <
&none              &kp Q              &kp W              &kp E              &kp R              &kp T                &kp Y              &kp U              &kp I              &kp O              &kp P              &none
&none              &kp A              &kp S              &kp D              &kp F              &kp G                &kp H              &kp J              &kp K              &kp L              &kp SEMI           &none
&none              &kp Z              &kp X              &kp C              &kp V              &kp B                &kp N              &kp M              &kp COMMA          &kp DOT            &kp SLASH          &none
                                       &kp ESC            &kp SPACE          &kp TAB            &kp RET            &kp BSPC           &kp DEL
      >;
    };

    // ===== Layer 3: BUTTON (clipboard & mouse buttons, symmetric) =====

    BUTTON {
      display-name = "Button";
      bindings = <
&none              &kp LG(Z)          &kp LG(X)          &kp LG(C)          &kp LG(V)          &kp LS(LG(Z))        &kp LS(LG(Z))      &kp LG(V)          &kp LG(C)          &kp LG(X)          &kp LG(Z)          &none
&none              &kp LGUI           &kp LALT           &kp LCTRL          &kp LSHFT          &none                &none              &kp LSHFT          &kp LCTRL          &kp LALT           &kp LGUI           &none
&none              &kp LG(Z)          &kp LG(X)          &kp LG(C)          &kp LG(V)          &kp LS(LG(Z))        &kp LS(LG(Z))      &kp LG(V)          &kp LG(C)          &kp LG(X)          &kp LG(Z)          &none
                                       &mkp MB3           &mkp MB1           &mkp MB2           &mkp MB2           &mkp MB1           &mkp MB3
      >;
    };

    // ===== Layer 4: NAV (Vim-style - hjkl = ← ↓ ↑ →) =====
    //
    // ,------------------------------------------.  ,------------------------------------------.
    // |      | BOOT | TAP  | EXTRA| BASE |      |  | REDO | PASTE| COPY | CUT  | UNDO |      |
    // |      | GUI  | ALT  | CTRL | SHIFT|      |  | CAPS |  ←   |  ↓   |  ↑   |  →   |      |
    // |      |      | RALT | NUM  | NAV  |      |  | INS  | HOME | PGDN | PGUP | END  |      |
    // `-------------|      |      |      |-------.  .------| RET  | BSPC | DEL  |-------------'

    NAV {
      display-name = "Nav";
      bindings = <
&none              &bootloader        &u_to_U_TAP        &u_to_U_EXTRA      &u_to_U_BASE       &none                &kp LS(LG(Z))      &kp LG(V)          &kp LG(C)          &kp LG(X)          &kp LG(Z)          &none
&none              &kp LGUI           &kp LALT           &kp LCTRL          &kp LSHFT          &none                &u_caps_word       &kp LEFT           &kp DOWN           &kp UP             &kp RIGHT          &none
&none              &none              &kp RALT           &u_to_U_NUM        &u_to_U_NAV        &none                &kp INS            &kp HOME           &kp PG_DN          &kp PG_UP          &kp END            &none
                                       &none              &none              &none              &kp RET            &kp BSPC           &kp DEL
      >;
    };

    // ===== Layer 5: MOUSE (Vim-style - hjkl = ← ↓ ↑ →) =====
    //
    // ,------------------------------------------.  ,------------------------------------------.
    // |      | BOOT | TAP  | EXTRA| BASE |      |  | REDO | PASTE| COPY | CUT  | UNDO |      |
    // |      | GUI  | ALT  | CTRL | SHIFT|      |  | SC↑  | MS←  | MS↓  | MS↑  | MS→  |      |
    // |      |      | RALT | SYM  | MOUSE|      |  | SC↓  | SC←  | WH_D | WH_U | SC→  |      |
    // `-------------|      |      |      |-------.  .------| BTN2 | BTN1 | BTN3 |-------------'

    MOUSE {
      display-name = "Mouse";
      bindings = <
&none              &bootloader        &u_to_U_TAP        &u_to_U_EXTRA      &u_to_U_BASE       &none                &kp LS(LG(Z))      &kp LG(V)          &kp LG(C)          &kp LG(X)          &kp LG(Z)          &none
&none              &kp LGUI           &kp LALT           &kp LCTRL          &kp LSHFT          &none                &msc SCRL_UP       &mmv MOVE_LEFT     &mmv MOVE_DOWN     &mmv MOVE_UP       &mmv MOVE_RIGHT    &none
&none              &none              &kp RALT           &u_to_U_SYM        &u_to_U_MOUSE      &none                &msc SCRL_DOWN     &msc SCRL_LEFT     &msc SCRL_DOWN     &msc SCRL_UP       &msc SCRL_RIGHT    &none
                                       &none              &none              &none              &mkp MB2           &mkp MB1           &mkp MB3
      >;
    };

    // ===== Layer 6: MEDIA (Vim-style - hjkl positions) =====
    //
    // ,------------------------------------------.  ,------------------------------------------.
    // |      | BOOT | TAP  | EXTRA| BASE |      |  | RGB  | EFF  |RGBHUI|RGBSAI|RGBBRI|      |
    // |      | GUI  | ALT  | CTRL | SHIFT|      |  |EP_TOG| PREV | VLDN | VLUP | NEXT |      |
    // |      |      | RALT | FUN  | MEDIA|      |  |OUTTOG| BT0  | BT1  | BT2  | BT3  |      |
    // `-------------|      |      |      |-------.  .------| STOP |  PP  | MUTE |-------------'

    MEDIA {
      display-name = "Media";
      bindings = <
&none              &bootloader        &u_to_U_TAP        &u_to_U_EXTRA      &u_to_U_BASE       &none                &rgb_ug RGB_TOG    &rgb_ug RGB_EFF    &rgb_ug RGB_HUI    &rgb_ug RGB_SAI    &rgb_ug RGB_BRI    &none
&none              &kp LGUI           &kp LALT           &kp LCTRL          &kp LSHFT          &none                &ext_power EP_TOG  &kp C_PREV         &kp C_VOL_DN       &kp C_VOL_UP       &kp C_NEXT         &none
&none              &none              &kp RALT           &u_to_U_FUN        &u_to_U_MEDIA      &none                &u_out_tog         &u_bt_sel_0        &u_bt_sel_1        &u_bt_sel_2        &u_bt_sel_3        &none
                                       &none              &none              &none              &kp C_STOP         &kp C_PP           &kp C_MUTE
      >;
    };

    // ===== Layer 7: NUM (number pad on left hand) =====
    //
    // ,------------------------------------------.  ,------------------------------------------.
    // |      |  [   |  7   |  8   |  9   |  ]   |  |      | BASE | EXTRA| TAP  | BOOT |      |
    // |      |  ;   |  4   |  5   |  6   |  =   |  |      | SHIFT| CTRL | ALT  | GUI  |      |
    // |      |  `   |  1   |  2   |  3   |  \   |  |      | NUM  | NAV  | RALT |      |      |
    // `-------------|  .   |  0   |  -   |-------.  .------|      |      |      |-------------'

    NUM {
      display-name = "Num";
      bindings = <
&none              &kp LBKT           &kp N7             &kp N8             &kp N9             &kp RBKT             &none              &u_to_U_BASE       &u_to_U_EXTRA      &u_to_U_TAP        &bootloader        &none
&none              &kp SEMI           &kp N4             &kp N5             &kp N6             &kp EQUAL            &none              &kp LSHFT          &kp LCTRL          &kp LALT           &kp LGUI           &none
&none              &kp GRAVE          &kp N1             &kp N2             &kp N3             &kp BSLH             &none              &u_to_U_NUM        &u_to_U_NAV        &kp RALT           &none              &none
                                       &kp DOT            &kp N0             &kp MINUS          &none              &none              &none
      >;
    };

    // ===== Layer 8: SYM (symbols on left hand) =====
    //
    // ,------------------------------------------.  ,------------------------------------------.
    // |      |  {   |  &   |  *   |  (   |  }   |  |      | BASE | EXTRA| TAP  | BOOT |      |
    // |      |  :   |  $   |  %   |  ^   |  +   |  |      | SHIFT| CTRL | ALT  | GUI  |      |
    // |      |  ~   |  !   |  @   |  #   |  |   |  |      | SYM  | MOUSE| RALT |      |      |
    // `-------------|  (   |  )   |  _   |-------.  .------|      |      |      |-------------'

    SYM {
      display-name = "Sym";
      bindings = <
&none              &kp LBRC           &kp AMPS           &kp ASTRK          &kp LPAR           &kp RBRC             &none              &u_to_U_BASE       &u_to_U_EXTRA      &u_to_U_TAP        &bootloader        &none
&none              &kp COLON          &kp DLLR           &kp PRCNT          &kp CARET          &kp PLUS             &none              &kp LSHFT          &kp LCTRL          &kp LALT           &kp LGUI           &none
&none              &kp TILDE          &kp EXCL           &kp AT             &kp HASH           &kp PIPE             &none              &u_to_U_SYM        &u_to_U_MOUSE      &kp RALT           &none              &none
                                       &kp LPAR           &kp RPAR           &kp UNDER          &none              &none              &none
      >;
    };

    // ===== Layer 9: FUN (function keys on left hand) =====
    //
    // ,------------------------------------------.  ,------------------------------------------.
    // |      | F12  |  F7  |  F8  |  F9  | PSCRN|  |      | BASE | EXTRA| TAP  | BOOT |      |
    // |      | F11  |  F4  |  F5  |  F6  | SLCK |  |      | SHIFT| CTRL | ALT  | GUI  |      |
    // |      | F10  |  F1  |  F2  |  F3  | PAUSE|  |      | FUN  | MEDIA| RALT |      |      |
    // `-------------|K_APP | SPACE| TAB  |-------.  .------|      |      |      |-------------'

    FUN {
      display-name = "Fun";
      bindings = <
&none              &kp F12            &kp F7             &kp F8             &kp F9             &kp PSCRN            &none              &u_to_U_BASE       &u_to_U_EXTRA      &u_to_U_TAP        &bootloader        &none
&none              &kp F11            &kp F4             &kp F5             &kp F6             &kp SLCK             &none              &kp LSHFT          &kp LCTRL          &kp LALT           &kp LGUI           &none
&none              &kp F10            &kp F1             &kp F2             &kp F3             &kp PAUSE_BREAK      &none              &u_to_U_FUN        &u_to_U_MEDIA      &kp RALT           &none              &none
                                       &kp K_APP          &kp SPACE          &kp TAB            &none              &none              &none
      >;
    };
  };
};
